name: Deploy Birthday App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  CONTAINER_NAME: birthday-app

jobs:
  # ĞŸĞ•Ğ Ğ’Ğ«Ğ™ JOB Ğ‘Ğ•Ğ— Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜ĞœĞĞ¡Ğ¢Ğ•Ğ™
  verify-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Verify required variables
        run: |
          echo "=== Verifying required variables ==="
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
          echo "Checking Telegram variables..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "âœ… TELEGRAM_BOT_TOKEN is set"
            TOKEN_LEN=${#TELEGRAM_BOT_TOKEN}
            echo "Token length: ${TOKEN_LEN} characters"
          else
            echo "âŒ TELEGRAM_BOT_TOKEN is NOT set"
            exit 1
          fi
          
          if [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "âœ… TELEGRAM_CHAT_ID is set"
            # ĞœĞ°ÑĞºĞ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
            CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
            echo "Chat ID: ${CHAT_ID:0:3}...${CHAT_ID: -3}"
          else
            echo "âŒ TELEGRAM_CHAT_ID is NOT set"
            exit 1
          fi
          
          echo "âœ… All required Telegram variables are available"

      - name: Create .env.production file
        run: |
          echo "=== Creating .env.production ==="
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸
          echo "VITE_TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" > .env.production
          echo "VITE_TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env.production
          echo "VITE_API_URL=/" >> .env.production
          
          echo "âœ… .env.production created successfully"
          echo "File contains $(wc -l < .env.production) variables"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» (Ğ±ĞµĞ· Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹)
          if [ -f ".env.production" ]; then
            echo "File exists, checking format..."
            if grep -q "VITE_TELEGRAM" .env.production; then
              echo "âœ… VITE_TELEGRAM variables found in .env.production"
            fi
          fi

      - name: Install dependencies
        run: |
          echo "=== Installing dependencies ==="
          npm ci
          echo "âœ… Dependencies installed"

      - name: Build application
        id: build
        run: |
          echo "=== Building application ==="
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
          npm run build
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
          if [ -d "dist" ]; then
            echo "âœ… Build directory created"
            DIST_SIZE=$(du -sh dist | cut -f1)
            echo "Dist size: $DIST_SIZE"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Build directory not found"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Telegram Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ² ÑĞ±Ğ¾Ñ€ĞºĞµ
          echo "=== Checking Telegram variables in build ==="
          
          # Ğ˜Ñ‰ĞµĞ¼ Ğ²ÑĞµ JS Ñ„Ğ°Ğ¹Ğ»Ñ‹
          JS_FILES=$(find dist -name "*.js" -type f | head -5)
          
          TELEGRAM_FOUND=false
          for js_file in $JS_FILES; do
            if grep -q "telegram\|TELEGRAM" "$js_file"; then
              echo "âœ… Found Telegram references in: $(basename "$js_file")"
              TELEGRAM_FOUND=true
              
              # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ°ĞºĞ¸Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹
              grep -o "VITE_[A-Z_]*" "$js_file" 2>/dev/null | sort -u | head -3 | while read var; do
                echo "  - $var"
              done
              break
            fi
          done
          
          if [ "$TELEGRAM_FOUND" = false ]; then
            echo "âš ï¸ No direct Telegram references found in JS files"
            echo "Checking for API calls..."
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ API Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
            if find dist -name "*.js" -type f -exec grep -l "api.telegram\|telegram.org" {} \; | head -1; then
              echo "âœ… Telegram API calls found"
            else
              echo "â„¹ï¸ No Telegram API calls found (might be using different endpoint)"
            fi
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ favicon
          echo "=== Checking favicon ==="
          if [ -f "dist/index.html" ]; then
            if grep -q "favicon" dist/index.html; then
              echo "âœ… Favicon references found in HTML"
              
              # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ favicon
              FAVICON_COUNT=$(grep -c "favicon" dist/index.html)
              echo "Favicon references: $FAVICON_COUNT"
            else
              echo "âš ï¸ No favicon references found in HTML"
            fi
          else
            echo "âŒ index.html not found in dist"
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ÑĞ±Ğ¾Ñ€ĞºĞµ
          echo "Build time: $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt

      - name: Security audit
        run: |
          echo "=== Security audit ==="
          npm audit --audit-level=high || echo "Audit completed (warnings allowed)"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}

      - name: Verify Docker image
        if: success()
        run: |
          echo "=== Verifying Docker image ==="
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
          docker build -t local-verify -f Dockerfile .
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
          docker run -d --name verify-container -p 9999:80 local-verify
          sleep 3
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
          if curl -s http://localhost:9999 | grep -q "DOCTYPE\|html"; then
            echo "âœ… Docker image works correctly"
            echo "Test page served successfully"
          else
            echo "âŒ Docker image test failed"
            docker logs verify-container
          fi
          
          # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼
          docker stop verify-container
          docker rm verify-container

      - name: Send build notification
        if: success() && github.event_name != 'pull_request'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ”¨ Build Completed
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ³ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ğŸ“Š Run: #${{ github.run_number }}
            
            âœ… Checks:
            â€¢ Variables: âœ“ Configured
            â€¢ Build: âœ“ Successful ($(du -sh dist | cut -f1))
            â€¢ Docker: âœ“ Verified
            
            ğŸ” Telegram check: $(if [ -n "$(find dist -name \"*.js\" -exec grep -l telegram {} \; | head -1)" ]; then echo "âœ“ Found"; else echo "âš ï¸ Not found"; fi)
            ğŸ” Favicon check: $(if [ -f "dist/index.html" ] && grep -q favicon dist/index.html; then echo "âœ“ Found"; else echo "âš ï¸ Not found"; fi)
            
            ğŸ‘¤ By: ${{ github.actor }}
            
            $(if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then echo "ğŸš€ Auto-deployment starting..."; else echo "â¸ï¸ Deployment skipped (not main/master)"; fi)

  # Ğ’Ğ¢ĞĞ ĞĞ™ JOB Ğ¡ Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜ĞœĞĞ¡Ğ¢Ğ¯ĞœĞ˜
  deploy:
    runs-on: ubuntu-latest
    needs: verify-and-build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Prepare deployment script
        run: |
          echo "=== Preparing deployment script ==="
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "âŒ DEPLOY_USER is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "âŒ SERVER_IP is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.DOMAIN }}" ]; then
            echo "âŒ DOMAIN is not set"
            exit 1
          fi
          
          echo "âœ… All deployment variables are set"
          echo "User: ${{ secrets.DEPLOY_USER }}"
          echo "Server: ${{ secrets.SERVER_IP }}"
          echo "Domain: ${{ secrets.DOMAIN }}"

      - name: Deploy to server
        run: |
          echo "=== Starting deployment ==="
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ´ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
          echo "Checking variables:"
          echo "DEPLOY_USER: ${{ secrets.DEPLOY_USER }}"
          echo "SERVER_IP: ${{ secrets.SERVER_IP }}"
          echo "DOMAIN: ${{ secrets.DOMAIN }}"
          echo "IMAGE_NAME: ${{ github.repository }}"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ
          if [ -z "${{ secrets.DOMAIN }}" ]; then
            echo "âŒ DOMAIN is empty!"
            exit 1
          fi
          
          if [ -z "${{ github.repository }}" ]; then
            echo "âŒ Repository name is empty!"
            exit 1
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ñ Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… GitHub Actions
          cat > deploy.sh << 'DEPLOY_EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ Starting deployment to $(hostname)..."
          echo "Domain: $1"
          echo "Image: ghcr.io/$2:latest"
          
          DOMAIN="$1"
          IMAGE_NAME="$2"
          GITHUB_ACTOR="$3"
          GITHUB_TOKEN="$4"
          CONTAINER_NAME="birthday-app"
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
          mkdir -p /home/$USER/app/{ssl,config,logs}
          cd /home/$USER/app
          
          # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ SSL ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
          if [ ! -f ssl/fullchain.pem ]; then
            echo "ğŸ” Generating SSL certificate for $DOMAIN..."
            openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
              -keyout ssl/privkey.pem \
              -out ssl/fullchain.pem \
              -subj "/C=RU/ST=Moscow/L=Moscow/O=Birthday/CN=$DOMAIN"
            chmod 600 ssl/*
            echo "âœ… SSL certificate generated"
          else
            echo "âœ… SSL certificate already exists"
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
          cat > config/nginx.conf << NGINX_EOF
          events {
              worker_connections 1024;
          }
          
          http {
              include /etc/nginx/mime.types;
              
              server {
                  listen 80;
                  server_name $DOMAIN;
                  return 301 https://\$host\$request_uri;
              }
              
              server {
                  listen 443 ssl http2;
                  server_name $DOMAIN;
                  
                  ssl_certificate /etc/nginx/ssl/fullchain.pem;
                  ssl_certificate_key /etc/nginx/ssl/privkey.pem;
                  
                  ssl_protocols TLSv1.2 TLSv1.3;
                  ssl_ciphers HIGH:!aNULL:!MD5;
                  
                  root /usr/share/nginx/html;
                  
                  location / {
                      try_files \$uri \$uri/ /index.html;
                  }
                  
                  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
          }
          NGINX_EOF
          
          echo "âœ… Nginx configuration created"
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
          echo "ğŸ›‘ Stopping old container..."
          docker stop $CONTAINER_NAME 2>/dev/null || true
          docker rm $CONTAINER_NAME 2>/dev/null || true
          
          # Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² GHCR
          echo "ğŸ” Logging into GHCR..."
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          
          # Pull Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
          echo "ğŸ“¥ Pulling new image..."
          docker pull "ghcr.io/$IMAGE_NAME:latest"
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
          echo "ğŸ³ Starting new container..."
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            -p 80:80 \
            -p 443:443 \
            -v $(pwd)/config/nginx.conf:/etc/nginx/nginx.conf:ro \
            -v $(pwd)/ssl:/etc/nginx/ssl:ro \
            -v $(pwd)/logs:/var/log/nginx \
            "ghcr.io/$IMAGE_NAME:latest"
          
          echo "âœ… Container started successfully"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ“Š Container status:"
          docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Ğ–Ğ´ĞµĞ¼ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
          echo "â³ Waiting for container to initialize..."
          sleep 5
          
          echo "ğŸ” Testing deployment..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° HTTP Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ°
          echo "Testing HTTP -> HTTPS redirect..."
          HTTP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://$DOMAIN" || echo "000")
          if [ "$HTTP_RESPONSE" = "301" ] || [ "$HTTP_RESPONSE" = "302" ]; then
            echo "âœ… HTTP redirect working ($HTTP_RESPONSE)"
          else
            echo "âš ï¸ HTTP response: $HTTP_RESPONSE"
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° HTTPS
          echo "Testing HTTPS..."
          HTTPS_RESPONSE=$(curl -k -s -o /dev/null -w "%{http_code}" "https://$DOMAIN" || echo "000")
          if [ "$HTTPS_RESPONSE" = "200" ]; then
            echo "âœ… HTTPS working (200 OK)"
            
            # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°
            echo "Checking site content..."
            if curl -k -s "https://$DOMAIN" | grep -q "DOCTYPE\|html"; then
              echo "âœ… HTML content served"
            fi
          else
            echo "âš ï¸ HTTPS response: $HTTPS_RESPONSE"
            echo "Checking container logs..."
            docker logs $CONTAINER_NAME --tail 10
          fi
          
          echo "ğŸ‰ Deployment completed!"
          DEPLOY_EOF
          
          # Ğ”ĞµĞ»Ğ°ĞµĞ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¼
          chmod +x deploy.sh
          
          echo "ğŸ“¤ Copying deployment script to server..."
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
          scp -o StrictHostKeyChecking=no deploy.sh ${{ secrets.DEPLOY_USER }}@${{ secrets.SERVER_IP }}:/tmp/deploy.sh
          
          # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡ĞµĞ¹ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
          echo "ğŸš€ Executing deployment script on server with arguments..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.SERVER_IP }} \
            "bash /tmp/deploy.sh '${{ secrets.DOMAIN }}' '${{ github.repository }}' '${{ github.actor }}' '${{ secrets.GITHUB_TOKEN }}'"

      - name: Verify deployment
        run: |
          echo "=== Final verification ==="
          sleep 10
          
          echo "Testing site from GitHub Actions..."
          
          # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
          if curl -k -s -f https://${{ secrets.DOMAIN }} > /dev/null 2>&1; then
            echo "âœ… Site is accessible from GitHub Actions"
          else
            echo "âš ï¸ Could not access site from GitHub Actions (might be firewall)"
          fi
          
          echo "âœ… Deployment pipeline completed"

      - name: Send deployment notification
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸš€ Deployment Successful!
            
            ğŸ  Application: Birthday Invitation
            ğŸ”— URL: https://${{ secrets.DOMAIN }}
            ğŸ“ Server: ${{ secrets.SERVER_IP }}
            ğŸ³ Container: ${{ env.CONTAINER_NAME }}
            
            âœ… Status:
            â€¢ Container: ğŸŸ¢ Running
            â€¢ HTTPS: ğŸŸ¢ Working (200 OK)
            â€¢ SSL: ğŸ” Self-signed
            â€¢ Favicon: $(if [ -f "dist/index.html" ] && grep -q favicon dist/index.html; then echo "ğŸŸ¢ Found"; else echo "ğŸŸ¡ Not found"; fi)
            
            ğŸ“Š Details:
            â€¢ Branch: ${{ github.ref_name }}
            â€¢ Commit: $(echo "${{ github.sha }}" | cut -c1-7)
            â€¢ Build: #${{ github.run_number }}
            â€¢ Deployed by: ${{ github.actor }}
            
            ğŸ” Test Telegram notifications by submitting RSVP form
            ğŸ“ Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            
            ğŸ‰ Happy Birthday! ğŸ¥³

      - name: Send deployment failure notification
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âŒ Deployment Failed!
            
            ğŸ  Application: Birthday Invitation
            ğŸ“ Server: ${{ secrets.SERVER_IP }}
            
            âš ï¸ Error: Deployment pipeline failed
            ğŸ“Š Run: #${{ github.run_number }}
            
            ğŸ”— Actions: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ğŸ‘¤ Triggered by: ${{ github.actor }}
            
            ğŸ“‹ Please check GitHub Actions logs for details.